<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>Erlang bindings for ZeroMQ messaging framework.
</title>
<link rel="stylesheet" type="text/css" href="stylesheet.css" title="EDoc">
</head>
<body bgcolor="white">
<div class="navbar"><a name="#navbar_top"></a><table width="100%" border="0" cellspacing="0" cellpadding="2" summary="navigation bar"><tr><td><a href="overview-summary.html" target="overviewFrame">Overview</a></td><td><a href="http://www.erlang.org/"><img src="erlang.png" align="right" border="0" alt="erlang logo"></a></td></tr></table></div>
<h1>Erlang bindings for ZeroMQ messaging framework.
</h1>
<p>Copyright © 2010 Serge Aleynikov and Dhammika Pathirana
</p>
<p><b>Version:</b> 0.1
</p>
<p><b>Authors:</b> Serge Aleynikov (<a href="mailto:saleyn at gmail dot com"><tt>saleyn at gmail dot com</tt></a>), Dhammika Pathirana (<a href="mailto:dhammika at gmail dot com"><tt>dhammika at gmail dot com</tt></a>).</p>


<ol>
<li><a href="#Overview">Overview</a></li>
<li><a href="#Building">Building</a></li>
<li><a href="#Issue_Tracking">Issue Tracking</a></li>
<li><a href="#Architecture">Architecture</a></li>
<li><a href="#Known_Limitations">Known Limitations</a></li>
<li><a href="#Usage">Usage</a></li>
</ol>

<h3><a name="Overview">Overview</a></h3>

<p>ZeroMQ is an open-source fast middleware messaging framework supporting 
unicast and multicast communications between peers using various convenient
design patterns.  This project aims at interperability of Erlang with other
ZeroMQ distributed clients that may be written in other languages.</p>

<p>ZeroMQ project is found here: <a href="http://zeromq.org" target="_top"><tt>http://zeromq.org</tt></a></p>

<h3><a name="Building">Building</a></h3>

<p>This implementation requires a feature of ZeroMQ that is
not yet included in the 2.0.6 release, and therefore ZeroMQ needs
to be patched by applying the <code>zeromq-2.0.6.poll.patch</code> patch.</p>

<pre>  # Get erlzmq and 0MQ projects

  $ cd /tmp
  $ git clone git://github.com/sustrik/zeromq2.git
  $ git clone git://github.com/saleyn/erlzmq.git
  
  # Patch ZeroMQ
    
  $ cp erlzmq/patches/zeromq-2.0.6.poll.patch /tmp/zeromq2/
  $ cd /tmp/zeromq2
  $ patch -p0 &lt; zeromq-2.0.6.poll.patch
  $ ./configure --with-pgm --prefix=/opt/zeromq-2.0.6
  $ make
  $ make install</pre>

<p>After applying the patch to ZeroMQ modify the path in <code>/tmp/erlzmq/c_src/Makefile</code> 
of the following variable to reflect location of ZeroMQ installation:</p>

<pre>ZMQ_DIR=/opt/zeromq-2.0.6</pre>

<p>Make sure that Erlang is installed and <code>erl</code> is in the <code>PATH</code>.</p>

<p>Run:</p>

<pre>  $ cd /tmp/erlzmq
  $ make
  $ make docs</pre>

<h3><a name="Issue_Tracking">Issue Tracking</a></h3>

<p><a href="http://github.com/saleyn/erlzmq/issues" target="_top"><tt>http://github.com/saleyn/erlzmq/issues</tt></a></p>

<h3><a name="Architecture">Architecture</a></h3>

<p>A ZeroMQ context is created by calling zmq:start_link/0 or
zmq:start_link/1 function optionally passing the number of I/O
threads to be used by ZeroMQ framework.  The number of 
application threads defaults to <code>1</code> and currently is not
configurable.</p>

<p>The ZeroMQ context is started and owned by the <code>zmq</code> process.
On the contrary, ZeroMQ sockets are owned by individual Erlang 
processes that communicate directly with the driver bypassing <code>zmq</code>
process.  This way individual pids can issue blocking recv/1 or 
send/2 calls without synchronizing them through the driver owner's
pid.</p>

<p>The driver is aware of socket ownership by monitoring Erlang pids 
that created sockets.  This means that a socket is automatically
garbage collected when the socket owner Erlang pid dies.</p>

<p>The semantics of socket creation function is slightly different 
from the corresponding <code>zmq_socket(3)</code> function in a way that 
it also accepts socket options:</p>

<pre>    {ok, Socket} = zmq:socket(req, [{active, true}, {hwm, 1000}]).</pre>

<p>All socket types and option names map 1-to-1 to corresponding 
names of ZeroMQ socket types and options except for <code>ZMQ_</code> prefix
being stripped.</p>

<p>A new socket option is added called <code>active</code>.  The option accepts
a boolean argument and has the following meaning.  If the option 
is <code>true</code>, all incoming messages are automatically delivered by
the driver to the owner's mailbox without explicit need to 
call zmq:recv/1.</p>

<p>If the option is <code>false</code> the owner must explicitely call zmq:recv/1
to receive a message from a ZeroMQ socket.  Use <code>{active, true}</code> 
mode with causion since if the messages are arriving at a rate faster
than the Erlang process can handle them the process's queue will
grow and eventually run out of memory.</p>

<p>zmq:send/2 and zmq:recv/1 calls may block the owner Erlang process
but will never block the Erlang VM.  The driver uses non-blocking
calls to <code>zmq_send(3)</code> and <code>zmq_recv(3)</code> functions and will not
deliver any result to the caller's pid until the message is 
successfully sent or received.  Currently timeout option is not
implemented on these two calls.</p>

<p>Many Erlang pids owning many ZeroMQ sockets can be easily started
in one Erlang VM.  However, it's more typical to have a small number
of ZeroMQ sockets in the system, since each socket can handle many
transport connections.</p>

<h3><a name="Known_Limitations">Known Limitations</a></h3>

<ul>
<li>The driver attaches ZeroMQ file descriptors to Erlang VM's 
    event loop and this functionality has only been tested with 
    using was tested with kernel poll enabled (use "+K true" 
    startup option)</li>
<li>The current architecture of ZeroMQ assumes that ZeroMQ sockets
    are owned by the thread that created them and all operations
    on these sockets should be done in the context of that thread.
    This is not how Erlang driver currently works.  All socket
    calls are synchronized so that no two concurrent threads 
    would access the same ZeroMQ socket simultaneously, however
    Erlang pid owning the ZeroMQ socket can be scheduled on 
    different OS kernel threads when Erlang is running with
    SMP support enabled.  We haven't tested this sufficiently to
    say if this is or isn't an issue.  There's an on-going 
    discussion (as of ZeroMQ version 2.0.7) to allow ZeroMQ
    sockets to be migrated between threads.</li>
</ul>

<h3><a name="Usage">Usage</a></h3>

<h4><a name="Sample_ZMQ_REQ_client">Sample ZMQ_REQ client</a></h4>
<pre>    $ erl +K true -smp disable -pa /path/to/zmq/ebin

    % Create ZeroMQ context
    1&gt; zmq:start_link().
    {ok,&lt;0.34.0&gt;}

    % Create a ZeroMQ REQ socket and specify that messages
    % are delivered to the current shell's mailbox.
    2&gt; {ok, S} = zmq:socket(req, [{active, true}]).
    {ok,{#Port&lt;0.623&gt;,1}}

    % Connect to server
    3&gt; zmq:connect(S, "tcp://127.0.0.1:5555").
    ok

    % Send a message to server
    4&gt; zmq:send(S, &lt;&lt;"Test"&gt;&gt;).
    ok

    % Receive a reply
    5&gt; zmq:recv(S).
    {error,einval}

    % Note the error - in the active socket mode we cannot
    % receive messages by calling zmq:recv/1. Instead
    % use receive keyword to accomplish the task.

    6&gt; f(M), receive M -&gt; M end.
    % The process blocks because there's no reply from server
    % Once you start the server as shown in the following steps
    % the receive call returns with the following message:
    {zmq,1,&lt;&lt;"Reply"&gt;&gt;}</pre>

<h4><a name="Sample_ZMQ_REP_server">Sample ZMQ_REP server</a></h4>

<p>Start another shell either within the same Erlang VM
by using ^G, or in a separate OS shell:</p>

<pre>    $ erl +K true -smp disable -pa /path/to/zmq/ebin

    1&gt; zmq:start_link().
    {ok,&lt;0.34.0&gt;}
    2&gt; {ok, S} = zmq:socket(rep, [{active, false}]).
    {ok,{#Port&lt;0.483&gt;,1}}
    3&gt; zmq:bind(S, "tcp://127.0.0.1:5555").
    ok
    4&gt; zmq:recv(S).
    {ok,&lt;&lt;"Test"&gt;&gt;}
    5&gt; zmq:send(S, &lt;&lt;"Reply"&gt;&gt;).
    ok</pre>


<hr>
<div class="navbar"><a name="#navbar_bottom"></a><table width="100%" border="0" cellspacing="0" cellpadding="2" summary="navigation bar"><tr><td><a href="overview-summary.html" target="overviewFrame">Overview</a></td><td><a href="http://www.erlang.org/"><img src="erlang.png" align="right" border="0" alt="erlang logo"></a></td></tr></table></div>
<p><i>Generated by EDoc, May 26 2010, 13:54:30.</i></p>
</body>
</html>
